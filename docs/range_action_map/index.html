<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="RangeAction Map"><meta name="keywords" content="rust, rustlang, rust-lang, range_action_map"><title>range_action_map - Rust</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../SourceSerif4-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../FiraSans-Regular.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../FiraSans-Medium.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../SourceCodePro-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../SourceSerif4-Bold.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../SourceCodePro-Semibold.ttf.woff2"><link rel="stylesheet" type="text/css" href="../normalize.css"><link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle"><link rel="stylesheet" type="text/css" href="../ayu.css" disabled><link rel="stylesheet" type="text/css" href="../dark.css" disabled><link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle"><script id="default-settings" ></script><script src="../storage.js"></script><script src="../crates.js"></script><script defer src="../main.js"></script>
    <noscript><link rel="stylesheet" href="../noscript.css"></noscript><link rel="alternate icon" type="image/png" href="../favicon-16x16.png"><link rel="alternate icon" type="image/png" href="../favicon-32x32.png"><link rel="icon" type="image/svg+xml" href="../favicon.svg"></head><body class="rustdoc mod crate"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle">&#9776;</button><a class="sidebar-logo" href="../range_action_map/index.html"><div class="logo-container"><img class="rust-logo" src="../rust-logo.svg" alt="logo"></div>
        </a><h2 class="location"></h2>
    </nav>
    <nav class="sidebar"><a class="sidebar-logo" href="../range_action_map/index.html"><div class="logo-container"><img class="rust-logo" src="../rust-logo.svg" alt="logo"></div>
        </a><h2 class="location"><a href="#">Crate range_action_map</a></h2><div class="sidebar-elems"><div class="block"><ul><li class="version">Version 0.1.1</li><li><a id="all-types" href="all.html">All Items</a></li></div></ul><section><div class="block"><ul><li><a href="#structs">Structs</a></li><li><a href="#enums">Enums</a></li><li><a href="#constants">Constants</a></li><li><a href="#traits">Traits</a></li><li><a href="#types">Type Definitions</a></li></ul></div></section><div id="sidebar-vars" data-name="range_action_map" data-ty="mod" data-relpath=""></div><script defer src="sidebar-items.js"></script></div></nav><main><div class="width-limiter"><div class="sub-container"><a class="sub-logo-container" href="../range_action_map/index.html"><img class="rust-logo" src="../rust-logo.svg" alt="logo"></a><nav class="sub"><div class="theme-picker hidden"><button id="theme-picker" aria-label="Pick another theme!" aria-haspopup="menu" title="themes"><img width="22" height="22" alt="Pick another theme!" src="../brush.svg"></button><div id="theme-choices" role="menu"></div></div><form class="search-form"><div class="search-container"><span></span><input class="search-input" name="search" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"><button type="button" id="help-button" title="help">?</button><a id="settings-menu" href="../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../wheel.svg"></a></div></form></nav></div><section id="main-content" class="content"><div class="main-heading">
    <h1 class="fqn"><span class="in-band">Crate <a class="mod" href="#">range_action_map</a><button id="copy-path" onclick="copy_path(this)" title="Copy item path to clipboard"><img src="../clipboard.svg" width="19" height="18" alt="Copy item path"></button></span></h1><span class="out-of-band"><a class="srclink" href="../src/range_action_map/lib.rs.html#1-356">source</a> · <a id="toggle-all-docs" href="javascript:void(0)" title="collapse all docs">[<span class="inner">&#x2212;</span>]</a></span></div><details class="rustdoc-toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><h2 id="rangeaction-map"><a href="#rangeaction-map">RangeAction Map</a></h2>
<p>一个区间树结构，用于提供 mmap / munmap / mprotect 时对区间的操作。</p>
<h3 id="使用"><a href="#使用">使用</a></h3>
<p>本项目有 <code>std</code> 环境和 <code>no_std</code> 两个选项。</p>
<p>如需在 <code>std</code> 环境使用，直接在 <code>Cargo.toml</code> 引入即可；
如需在内核中使用，则需要选择：</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="ident">range</span><span class="op">-</span><span class="ident">action</span><span class="op">-</span><span class="ident">map</span> <span class="op">=</span> { <span class="ident">path</span> <span class="op">=</span> <span class="string">&quot;https://github.com/scPointer/maturin/tree/memory-area-mod/range-action-map&quot;</span>, <span class="ident">default</span><span class="op">-</span><span class="ident">features</span> <span class="op">=</span> <span class="bool-val">false</span> }</code></pre></div>
<h3 id="测试"><a href="#测试">测试</a></h3>
<p>本项目来自 <code>https://github.com/scPointer/maturin</code>。</p>
<p>其中 crate 源码在 <code>https://github.com/scPointer/maturin/tree/master/range-action-map</code>，
对这个 crate 本身的单元测试在  <code>https://github.com/scPointer/maturin/tree/master/range-action-map-test</code>。</p>
<p>单元测试本身只包含对数据结构本身的测试，不涉及页表和内存分配。实际在内存中的应用见下</p>
<h3 id="应用"><a href="#应用">应用</a></h3>
<p>主要在 <code>https://github.com/scPointer/maturin/kernel</code> 模块中，
<strong>下面的路径都以这个模块为当前路径做描述</strong></p>
<ul>
<li>在 <code>src/memory/areas/mod.rs</code> 中，描述了内核里的 <code>VmArea</code> 如何实现这个模块的 <code>trait Segment</code></li>
<li>在 <code>src/memory/vmm.rs</code> 中，描述了内核里的 <code>MemorySet</code> 如何使用这个模块的 <code>RangeActionMap</code></li>
<li>
<ul>
<li>以及如何使用 <code>VmArea</code></li>
</ul>
</li>
<li>在 <code>Cargo.toml</code> 中，描述了如何引入本模块</li>
</ul>
<h3 id="对外提供接口"><a href="#对外提供接口">对外提供接口</a></h3>
<p>RangeActionMap 主要提供以下操作：</p>
<ul>
<li><code>unmap(start, end)</code>：拆分/缩短/删除部分现有区间，空出<code>[start, end)</code> 这一段。</li>
<li><code>mprotect(start, end)</code>：修改所有区间与 <code>[start,end)</code> 相交的部分的属性。没有被 <code>[start, end)</code> 覆盖的区间会被拆分。</li>
<li><code>mmap_fixed(start, end)</code>：<code>unmap(start, end)</code>，并插入一个(用户给定的)新区间在<code>[start, end)</code>。</li>
<li><code>mmap_anywhere(hint, len)</code>：不修改任何区间，寻找一个长为 len 且左端点不小于 <code>hint</code> 的空位，并插入一个(用户给定的)新区间，返回插入位置的左端点。</li>
</ul>
<p>还提供以下接口：</p>
<ul>
<li><code>find(pos: usize)</code>：查询一个点是否在某个区间在，如果在，返回它的引用。</li>
<li><code>.iter()</code> <code>.iter_mut()</code>：迭代器支持。</li>
<li><code>impl Debug</code>：可以用 Debug 属性输出所有区间信息(需要用户提供的底层 <code>SegmentType</code> 实现 <code>Debug</code>)。</li>
</ul>
<p>创建：</p>
<ul>
<li><code>new(args: ArgsType)</code></li>
</ul>
<h3 id="需要用户提供的接口和约定"><a href="#需要用户提供的接口和约定">需要用户提供的接口和约定</a></h3>
<p><code>RangeActionMap</code> 需要一个实现 <code>trait Segment</code> 的类型，至少实现删除、拆分、修改三个操作：</p>
<ul>
<li><code>remove()</code>：删除这段区间</li>
<li><code>split(pos)</code>：从<code>pos</code>位置把当前区间拆成两段区间(pos 参数为全局的绝对位置而非区间内位置)</li>
<li><code>modify(new_flags)</code>：修改区间的属性</li>
</ul>
<p>一些约定：</p>
<ul>
<li>删除区间时需要用户底层结构完成返还页帧、修改页表等操作，但不需要 <code>Drop</code> 结构本身</li>
<li>其中每个区间有一个 usize 大小的可修改的属性，在用于内存管理时，它一般是 PTEFlags</li>
<li>
<ul>
<li>(尽管这个结构只需要u8，但我们希望这个属性至少可以放下一个 raw_pointer 以便扩展其他用途)。</li>
</ul>
</li>
<li><strong>此外，<code>RangeActionMap</code>创建时要求传入一个 <code>ArgsType</code>，它实际上是一个 usize。这个值会在每次操作时传递给底层区间</strong></li>
</ul>
</div></details><h2 id="structs" class="small-section-header"><a href="#structs">Structs</a></h2>
<div class="item-table"><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.RangeActionMap.html" title="range_action_map::RangeActionMap struct">RangeActionMap</a></div><div class="item-right docblock-short"><p>一个数据结构，维护互不相交的左闭右开区间。
其中每个区间有一个 usize 大小的可修改的属性，在用于内存管理时，它一般是 PTEFlags
(尽管这个结构只需要u8，但我们希望这个属性至少可以放下一个 raw_pointer 以便扩展其他用途)。</p>
</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.RangeActionMapIter.html" title="range_action_map::RangeActionMapIter struct">RangeActionMapIter</a></div><div class="item-right docblock-short"></div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.RangeActionMapIterMut.html" title="range_action_map::RangeActionMapIterMut struct">RangeActionMapIterMut</a></div><div class="item-right docblock-short"></div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.RangeArea.html" title="range_action_map::RangeArea struct">RangeArea</a></div><div class="item-right docblock-short"></div></div></div><h2 id="enums" class="small-section-header"><a href="#enums">Enums</a></h2>
<div class="item-table"><div class="item-row"><div class="item-left module-item"><a class="enum" href="enum.CutSet.html" title="range_action_map::CutSet enum">CutSet</a></div><div class="item-right docblock-short"><p>当前 VmArea 和另一个给定的需要 mprotect 的区间的相交关系</p>
</div></div><div class="item-row"><div class="item-left module-item"><a class="enum" href="enum.DiffSet.html" title="range_action_map::DiffSet enum">DiffSet</a></div><div class="item-right docblock-short"><p>当前 VmArea 和另一个给定的需要 unmap 的区间的相交关系</p>
</div></div></div><h2 id="constants" class="small-section-header"><a href="#constants">Constants</a></h2>
<div class="item-table"><div class="item-row"><div class="item-left module-item"><a class="constant" href="constant.LOWER_LIMIT.html" title="range_action_map::LOWER_LIMIT constant">LOWER_LIMIT</a></div><div class="item-right docblock-short"><p>4 KB</p>
</div></div><div class="item-row"><div class="item-left module-item"><a class="constant" href="constant.UPPER_LIMIT.html" title="range_action_map::UPPER_LIMIT constant">UPPER_LIMIT</a></div><div class="item-right docblock-short"><p>4 GB</p>
</div></div></div><h2 id="traits" class="small-section-header"><a href="#traits">Traits</a></h2>
<div class="item-table"><div class="item-row"><div class="item-left module-item"><a class="trait" href="trait.Segment.html" title="range_action_map::Segment trait">Segment</a></div><div class="item-right docblock-short"><p>维护一段相同权限的地址区间的线段</p>
</div></div></div><h2 id="types" class="small-section-header"><a href="#types">Type Definitions</a></h2>
<div class="item-table"><div class="item-row"><div class="item-left module-item"><a class="type" href="type.ArgsType.html" title="range_action_map::ArgsType type">ArgsType</a></div><div class="item-right docblock-short"></div></div><div class="item-row"><div class="item-left module-item"><a class="type" href="type.IdentType.html" title="range_action_map::IdentType type">IdentType</a></div><div class="item-right docblock-short"></div></div></div></section><section id="search" class="content hidden"></section></div></main><div id="rustdoc-vars" data-root-path="../" data-current-crate="range_action_map" data-themes="ayu,dark,light" data-resource-suffix="" data-rustdoc-version="1.62.0-nightly (1f7fb6413 2022-04-10)" ></div>
</body></html>